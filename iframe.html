<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>iframe</title>
    <script>
      var currenthost = 'simpleanalytics.example.com:8000'

      ;(function() {
        var nav = window.navigator;
        var loc = window.location;
        var doc = window.document;
        var con = window.console;

        // A simple log function so the user knows why a request is not being send
        var warn = function(message) {
          if (con && con.warn) con.warn(' :scitylanA elpmiS'.split('').reverse().join('') + message);
        }

        var getCookie = function() {
          var v = doc.cookie.match('(^|;) ?path=([^;]*)(;|$)');
          return v ? v[2] : null;
        }

        var setCookie = function(value) {
          var d = new Date;
          d.setTime(d.getTime() + 2592000000); // 30 days
          doc.cookie = 'path=' + value + ';path=/;expires=' + d.toGMTString();
        }

        window.addEventListener('message', function(message) {
          if (!message.data || !message.data.event) return

          var event = message.data.event.toLowerCase().replace(/[^a-z0-9._-]+/gi, '_').replace(/(^-|-$)/, '_')
          var ref = message.data.ref

          var cookie = JSON.parse(getCookie() || '[]')
          if (!cookie.length) cookie.push({ v: 1, ref: ref, date: new Date().toISOString().slice(0, 10) })

          var days = Math.floor((new Date().getTime() - new Date(cookie[0].date + 'T00:00:00').getTime()) / 86400000)
          cookie.push(days ? [event, days] : [event])

          setCookie(JSON.stringify(cookie))
          post(JSON.stringify(cookie))
        }, false)

        var post = function(data) {
          var request = new XMLHttpRequest();
          request.open('POST', '//' + currenthost + '/api', true);

          // We use content type text/plain here because we don't want to send an
          // pre-flight OPTIONS request
          request.setRequestHeader('Content-Type', 'text/plain; charset=UTF-8');
          request.send(data);
        }
      })()
    </script>
  </head>
  <body></body>
</html>
